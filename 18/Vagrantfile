Vagrant.configure("2") do |config|
  config.vm.define "centos-7n" do |srv|
    srv.vm.box = "centos/7"

    srv.vm.provider "virtualbox" do |vb|
      vb.memory = 1024
      vb.cpus = 2
      vb.name = "centos-7n"
      vb.customize ['modifyvm', :id, '--audio', 'none']
    end

    srv.vm.disk :disk, size: "1GB", name: "disk1"
    srv.vm.disk :disk, size: "1GB", name: "disk2"

    srv.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"

    srv.vm.provision "shell", inline: <<-SHELL
      set -e

      while [ ! -b /dev/sdb ]; do sleep 1; done
      while [ ! -b /dev/sdc ]; do sleep 1; done

      blkid /dev/sdb || mkfs.ext4 -F /dev/sdb
      blkid /dev/sdc || mkfs.ext4 -F /dev/sdc

      mkdir -p /mnt/disk1
      mkdir -p /mnt/disk2

      grep -q "^/dev/sdb" /etc/fstab || echo "/dev/sdb /mnt/disk1 ext4 defaults 0 0" >> /etc/fstab
      grep -q "^/dev/sdc" /etc/fstab || echo "/dev/sdc /mnt/disk2 ext4 defaults 0 0" >> /etc/fstab

      mount -a
    SHELL
  end
end
